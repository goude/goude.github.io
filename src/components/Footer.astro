---
import pkg from "../../package.json";

const now = new Date();

/**
 * ISO week number (SS-ISO 8601-1), using LOCAL week semantics but DST-safe math.
 *
 * - Decide week/year using local weekday (Mon=1..Sun=7) and local "Thursday shift".
 * - Do all differences at UTC midnight to avoid 23/25-hour days.
 */
const getISOWeek = (date: Date): number => {
  // 1) Local ISO weekday: Mon=1..Sun=7
  const dLocal = new Date(date);
  const jsDow = dLocal.getDay(); // 0=Sun..6=Sat (LOCAL)
  const isoDow = jsDow === 0 ? 7 : jsDow; // 1..7

  // 2) Shift to the Thursday of this ISO week (LOCAL shift to pick the week-year)
  const th = new Date(dLocal);
  th.setDate(th.getDate() + (4 - isoDow)); // local shift

  // 3) Week-year is the Gregorian year of that Thursday (LOCAL)
  const weekYear = th.getFullYear();

  // 4) Week 1 is the week containing Jan 4 (ISO). Find its MONDAY.
  const jan4 = new Date(weekYear, 0, 4); // LOCAL date object
  const jan4IsoDow = jan4.getDay() === 0 ? 7 : jan4.getDay(); // 1..7
  const week1Mon = new Date(weekYear, 0, 4 - (jan4IsoDow - 1)); // LOCAL date object (Monday of week 1)

  // 5) Compute day difference at UTC midnight to avoid DST artifacts
  const toUTCmid = (d: Date) =>
    Date.UTC(d.getFullYear(), d.getMonth(), d.getDate());

  const daysSinceWeek1Mon = Math.round(
    (toUTCmid(th) - toUTCmid(week1Mon)) / 86400000,
  );

  // 6) Week number
  return Math.floor(daysSinceWeek1Mon / 7) + 1;
};

const pad = (n: number) => String(n).padStart(2, "0");

const week = getISOWeek(now);

// Keep BUILD_TIMESTAMP in local time for consistency with the week computation.
// __BUILD_TIMESTAMP__ should be injected by your bundler as a numeric epoch millis or ISO string.
const build = new Date(__BUILD_TIMESTAMP__ as unknown as number | string);
const buildParts = {
  date: `${build.getFullYear()}-${pad(build.getMonth() + 1)}-${pad(build.getDate())}`,
  time: `${pad(build.getHours())}:${pad(build.getMinutes())}`,
};

const nowParts = {
  date: `${now.getFullYear()}-${pad(now.getMonth() + 1)}-${pad(now.getDate())}`,
  time: `${pad(now.getHours())}:${pad(now.getMinutes())}`,
};

// Timezone offset display (+HH:MM / -HH:MM) in LOCAL time
const tzOffset = -now.getTimezoneOffset();
const sign = tzOffset >= 0 ? "+" : "-";
const tzH = pad(Math.floor(Math.abs(tzOffset) / 60));
const tzM = pad(Math.abs(tzOffset) % 60);
const tz = `${sign}${tzH}:${tzM}`;
---

<style>
  .faded {
    opacity: 0.2;
  }
  .clickable {
    cursor: pointer;
    text-decoration: underline dotted;
  }

  footer {
    font:
      14px/1.4 system-ui,
      -apple-system,
      Segoe UI,
      Roboto,
      "Helvetica Neue",
      Arial,
      "Noto Sans",
      "Apple Color Emoji",
      "Segoe UI Emoji";
    color: inherit;
  }
  footer a {
    color: inherit;
  }
</style>

<footer>
  © {now.getFullYear()}
  <a href="https://goude.se">goude.se</a> ·
  <a href="/rubiks" title="ISO week (Sweden: SS-ISO 8601-1)">Week {week}</a> ·
  <a href="/sitemap">v{pkg.version}</a> · Built {buildParts.date}<span
    class="faded">T</span
  >{buildParts.time} · ⊛
</footer>
