---
// ThemeToggle - Client-side theme switching with system preference support
---

<button
  class="theme-toggle"
  id="theme-toggle"
  type="button"
  aria-label="Toggle theme"
>
  <i class="fa-regular fa-sun" id="icon-light" aria-hidden="true"></i>
  <i class="fa-solid fa-moon" id="icon-dark" aria-hidden="true"></i>
</button>

<style>
  .theme-toggle {
    background: none;
    border: none;
    font-size: 1.1em;
    cursor: pointer;
    padding: 0.25rem 0.6rem;
    color: inherit;
    transition: opacity 0.15s ease;
  }

  .theme-toggle:hover {
    opacity: 0.7;
  }

  #icon-dark {
    display: none;
  }

  :global([data-theme-dark]) #icon-light {
    display: none;
  }

  :global([data-theme-dark]) #icon-dark {
    display: inline;
  }
</style>

<script is:inline>
  (function () {
    const STORAGE_KEY = "theme";
    const DARK = "dark";
    const LIGHT = "light";

    function getStoredTheme() {
      const stored = localStorage.getItem(STORAGE_KEY);
      return stored === DARK || stored === LIGHT ? stored : null;
    }

    function getSystemTheme() {
      return window.matchMedia?.("(prefers-color-scheme: dark)").matches
        ? DARK
        : LIGHT;
    }

    function getCurrentTheme() {
      return getStoredTheme() ?? getSystemTheme();
    }

    function applyTheme(theme) {
      const root = document.documentElement;
      root.toggleAttribute("data-theme-dark", theme === DARK);
      root.toggleAttribute("data-theme-light", theme === LIGHT);
    }

    // Apply immediately to prevent flash
    applyTheme(getCurrentTheme());

    // Setup toggle button
    document.getElementById("theme-toggle")?.addEventListener("click", () => {
      const isDark = document.documentElement.hasAttribute("data-theme-dark");
      const next = isDark ? LIGHT : DARK;
      localStorage.setItem(STORAGE_KEY, next);
      applyTheme(next);
    });

    // Listen for system preference changes
    window.matchMedia?.("(prefers-color-scheme: dark)").addEventListener("change", () => {
      if (!getStoredTheme()) {
        applyTheme(getSystemTheme());
      }
    });
  })();
</script>
