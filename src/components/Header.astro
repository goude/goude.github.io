---
import { NAV_ITEMS, type NavItem } from "@/types/site";
import rawLogoSvg from "@/assets/goude-se-logo.svg?raw";

const SWATCH_TO_VAR = {
  "tone-green": "var(--tone-green)",
  "tone-blue": "var(--tone-blue)",
  "tone-purple": "var(--tone-purple)",
  "tone-yellow": "var(--tone-yellow)",
  "tone-red": "var(--tone-red)",
  currentColor: "currentColor",

  bg: "var(--bg)",
  fg: "var(--fg)",
  accent: "var(--accent)",
  paper: "var(--paper)",

  "fg-muted": "var(--fg-muted)",
  rule: "var(--rule)",
  surface: "var(--surface)",
};

function mapInkscapeSwatches(svg: any) {
  let out = svg;

  for (const [label, cssVar] of Object.entries(SWATCH_TO_VAR)) {
    const re = new RegExp(
      `(inkscape:label="${label}"[\\s\\S]*?<stop[^>]+stop-color:)[^;"]+`,
      "g"
    );
    out = out.replace(re, `$1${cssVar}`);
  }

  return out;
}

const logoSvg = mapInkscapeSwatches(rawLogoSvg);

interface Props {
  current?: string | undefined;
}

const { current = "" } = Astro.props;

function isSelected(item: NavItem): boolean {
  return item.href === `/${current}`;
}

const navLeft = NAV_ITEMS.filter((item) => !item.external);
const navRight = NAV_ITEMS.filter((item) => item.external);
---

<header class="site-header">
  <!-- Logo / Home -->
  <a
    href="/"
    aria-label="Home"
    class:list={["logo", "nav-action", { selected: current === "" }]}
    title="Guard what you give your attention to. It quietly becomes who you are."
  >
    <span class="logo-svg" aria-hidden="true" set:html={logoSvg} />
  </a>

  <!-- Hamburger (mobile only) -->
  <button
    class="menu-toggle btn"
    id="menu-toggle"
    type="button"
    aria-label="Toggle navigation menu"
    aria-controls="menu-panel"
    aria-expanded="false"
  >
    <i class="fa-solid fa-bars" aria-hidden="true"></i>
  </button>

  <!-- Desktop nav (left) -->
  <nav class="main-nav desktop-only" aria-label="Main navigation">
    {
      navLeft.map((item) => (
        <a
          href={item.href}
          class:list={["nav-action", { selected: isSelected(item) }]}
        >
          <i class={item.icon} aria-hidden="true" />
          <span>{item.label}</span>
        </a>
      ))
    }
  </nav>

  <!-- Desktop right cluster -->
  <div class="toggles desktop-only" aria-label="Appearance controls">
    <nav class="main-nav right-nav" aria-label="External links">
      {
        navRight.map((item) => (
          <a
            href={item.href}
            class="nav-action icon-only"
            rel="noopener noreferrer"
            target="_blank"
            aria-label={`${item.label} (opens in new tab)`}
          >
            <i class={item.icon} aria-hidden="true" />
            <span class="tooltip">
              {item.label}
              <i
                class="fa-solid fa-arrow-up-right-from-square external-icon"
                aria-hidden="true"
              />
            </span>
          </a>
        ))
      }
    </nav>

    <button
      class="mode-toggle nav-action icon-only"
      id="mode-toggle"
      type="button"
      aria-label="Toggle content detail level"
    >
      <i class="fa-regular fa-circle" data-mode-icon="normal" aria-hidden="true"
      ></i>
      <i
        class="fa-regular fa-note-sticky"
        data-mode-icon="notes"
        aria-hidden="true"></i>
      <i class="fa-solid fa-brain" data-mode-icon="thoughts" aria-hidden="true"
      ></i>
      <span class="tooltip" data-mode-tooltip="normal">Basic Detail</span>
      <span class="tooltip" data-mode-tooltip="notes">Higher Detail</span>
      <span class="tooltip" data-mode-tooltip="thoughts">Super Detail</span>
    </button>

    <button
      class="theme-toggle nav-action icon-only tooltip-right"
      id="theme-toggle"
      type="button"
      aria-label="Toggle theme"
    >
      <i class="fa-regular fa-sun" id="icon-light" aria-hidden="true"></i>
      <i class="fa-solid fa-moon" id="icon-dark" aria-hidden="true"></i>
      <span class="tooltip" data-theme-tooltip="light">Brother Day</span>
      <span class="tooltip" data-theme-tooltip="dark">Brother Dusk</span>
    </button>
  </div>

  <!-- Mobile pancake menu -->
  <nav class="menu-panel" id="menu-panel" aria-label="Menu">
    <div class="menu-divider" aria-hidden="true"></div>

    {
      NAV_ITEMS.map((item) => (
        <a
          href={item.href}
          class:list={["menu-item", { selected: isSelected(item) }]}
          {...(item.external
            ? { rel: "noopener noreferrer", target: "_blank" }
            : {})}
        >
          <i class={item.icon} aria-hidden="true" />
          <span>{item.label}</span>
          {item.external && (
            <i
              class="fa-solid fa-arrow-up-right-from-square external-icon"
              aria-hidden="true"
            />
          )}
        </a>
      ))
    }

    <button class="menu-item menu-action" id="mode-toggle-menu" type="button">
      <i class="fa-regular fa-circle" data-mode-icon="normal" aria-hidden="true"
      ></i>
      <i
        class="fa-regular fa-note-sticky"
        data-mode-icon="notes"
        aria-hidden="true"></i>
      <i class="fa-solid fa-brain" data-mode-icon="thoughts" aria-hidden="true"
      ></i>
      <span data-mode-label="normal">Basic Detail</span>
      <span data-mode-label="notes">Higher Detail</span>
      <span data-mode-label="thoughts">Super Detail</span>
    </button>

    <button class="menu-item menu-action" id="theme-toggle-menu" type="button">
      <i class="fa-regular fa-sun" data-theme-icon="light" aria-hidden="true"
      ></i>
      <i class="fa-solid fa-moon" data-theme-icon="dark" aria-hidden="true"></i>
      <span data-theme-label="light">Brother Day</span>
      <span data-theme-label="dark">Brother Dusk</span>
    </button>
  </nav>
</header>

<style>
  /* ---------- base ---------- */
  .site-header {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.5rem;
    font-family: var(--font-sans);
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Mobile-only hamburger button */
  .btn {
    background: none;
    border: none;
    cursor: pointer;
    padding: 0.25rem 0.6rem;
    color: inherit;
    transition: opacity 0.15s ease;
    font-family: var(--font-sans);
    font-size: 1.05em;
  }
  .btn:hover {
    opacity: 0.7;
  }

  /* ---------- Unified nav item styling ---------- */
  .nav-action {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    text-decoration: none;
    color: inherit;

    font-family: var(--font-sans);
    font-weight: 700;
    letter-spacing: 0.08em;
    white-space: nowrap;

    background: none;
    border: none;
    cursor: pointer;

    transition:
      background-color 0.15s ease,
      color 0.15s ease,
      opacity 0.15s ease;
  }

  .nav-action:hover {
    opacity: 0.7;
  }

  .nav-action i {
    font-size: 1.1em;
  }

  /* Shared selected style */
  .selected {
    background: var(--fg);
    color: var(--bg);
  }

  /* ---------- Logo ---------- */
  .logo {
    flex-shrink: 0;
  }

  .logo-svg {
    display: flex;
    align-items: center;
    height: 1.4em;
    line-height: 1;
  }

  .logo-svg :global(svg) {
    display: block;
    height: 100%;
    width: auto;
  }

  /* Desktop nav containers */
  .main-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-sans);
    font-weight: 700;
  }

  /* Desktop right cluster */
  .toggles {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  /* ---------- Icon-only with tooltip ---------- */
  .icon-only {
    position: relative;
  }

  .icon-only .tooltip {
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(0.25rem);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    background: var(--fg);
    color: var(--bg);
    font-size: 0.75em;
    font-weight: 700;
    letter-spacing: 0.04em;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition:
      opacity 0.15s ease,
      transform 0.15s ease;
    z-index: 100;
  }

  .icon-only:hover .tooltip,
  .icon-only:focus-visible .tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(0.4rem);
  }

  /* Right-aligned tooltip for rightmost item to prevent cutoff */
  .icon-only.tooltip-right .tooltip {
    left: auto;
    right: 0;
    transform: translateX(0) translateY(0.25rem);
  }

  .icon-only.tooltip-right:hover .tooltip,
  .icon-only.tooltip-right:focus-visible .tooltip {
    transform: translateX(0) translateY(0.4rem);
  }

  .external-icon {
    margin-left: 0.3em;
    font-size: 0.85em;
    opacity: 0.7;
  }

  /* Hamburger positioning (mobile top row) */
  .menu-toggle {
    margin-left: auto;
  }

  /* Theme icons (desktop) */
  #icon-dark {
    display: none;
  }
  :global([data-theme-dark]) #icon-light {
    display: none;
  }
  :global([data-theme-dark]) #icon-dark {
    display: inline;
  }

  /* Theme tooltips (desktop) */
  .theme-toggle [data-theme-tooltip="dark"] {
    display: none;
  }
  :global([data-theme-dark]) .theme-toggle [data-theme-tooltip="light"] {
    display: none;
  }
  :global([data-theme-dark]) .theme-toggle [data-theme-tooltip="dark"] {
    display: block;
  }

  /* Mode icons (desktop) */
  .mode-toggle [data-mode-icon] {
    display: none;
  }
  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="normal"],
  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="notes"],
  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: inline;
  }

  /* Mode tooltips (desktop) */
  .mode-toggle [data-mode-tooltip] {
    display: none;
  }
  :global([data-mode="normal"]) .mode-toggle [data-mode-tooltip="normal"],
  :global([data-mode="notes"]) .mode-toggle [data-mode-tooltip="notes"],
  :global([data-mode="thoughts"]) .mode-toggle [data-mode-tooltip="thoughts"] {
    display: block;
  }

  /* Mobile menu defaults */
  .menu-toggle,
  .menu-panel {
    display: none;
  }

  @media (max-width: 480px) {
    .site-header {
      flex-wrap: wrap;
    }

    .desktop-only {
      display: none !important;
    }

    .menu-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .menu-panel {
      width: 100%;
      flex-basis: 100%;
      order: 999;
      display: none;
      flex-direction: column;
      align-items: stretch;
      gap: 0.25rem;
      padding: 0.25rem 0;
      font-family: var(--font-sans);
      font-weight: 700;
    }

    :global([data-nav-open="true"]) .menu-panel {
      display: flex;
    }

    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.6rem;
      border-radius: 12px;
      text-decoration: none;
      letter-spacing: 0.04em;
      font-size: 0.98em;
      font-family: var(--font-sans);
      font-weight: 700;
      color: inherit;
    }

    .menu-item .external-icon {
      margin-left: auto;
    }

    .menu-item i {
      font-size: 1em;
    }

    .menu-action {
      background: none;
      border: none;
      cursor: pointer;
      text-align: left;
    }

    .menu-divider {
      height: 1px;
      opacity: 0.15;
      background: currentColor;
      margin: 0.15rem 0.6rem;
    }

    /* Theme icons (mobile menu) */
    .menu-panel [data-theme-icon="dark"] {
      display: none;
    }
    :global([data-theme-dark]) .menu-panel [data-theme-icon="light"] {
      display: none;
    }
    :global([data-theme-dark]) .menu-panel [data-theme-icon="dark"] {
      display: inline;
    }

    /* Theme labels (mobile menu) */
    .menu-panel [data-theme-label="dark"] {
      display: none;
    }
    :global([data-theme-dark]) .menu-panel [data-theme-label="light"] {
      display: none;
    }
    :global([data-theme-dark]) .menu-panel [data-theme-label="dark"] {
      display: inline;
    }

    /* Mode icons (mobile menu) */
    .menu-panel [data-mode-icon] {
      display: none;
    }
    :global([data-mode="normal"]) .menu-panel [data-mode-icon="normal"],
    :global([data-mode="notes"]) .menu-panel [data-mode-icon="notes"],
    :global([data-mode="thoughts"]) .menu-panel [data-mode-icon="thoughts"] {
      display: inline;
    }

    /* Mode labels (mobile menu) */
    .menu-panel [data-mode-label] {
      display: none;
    }
    :global([data-mode="normal"]) .menu-panel [data-mode-label="normal"],
    :global([data-mode="notes"]) .menu-panel [data-mode-label="notes"],
    :global([data-mode="thoughts"]) .menu-panel [data-mode-label="thoughts"] {
      display: inline;
    }
  }
</style>

<script is:inline>
  (function () {
    "use strict";

    const STORAGE = { theme: "theme", mode: "mode" };
    const THEMES = ["light", "dark"];
    const MODES = ["normal", "notes", "thoughts"];
    const root = document.documentElement;

    const prefersDark = () =>
      window.matchMedia?.("(prefers-color-scheme: dark)").matches;

    const readStored = (key, allowed) => {
      const v = localStorage.getItem(key);
      return allowed.includes(v) ? v : null;
    };

    const cycle = (cur, list) => list[(list.indexOf(cur) + 1) % list.length];

    const applyTheme = (t) => {
      root.toggleAttribute("data-theme-dark", t === "dark");
      root.toggleAttribute("data-theme-light", t === "light");
    };

    const applyMode = (m) => {
      root.setAttribute("data-mode", m);
    };

    const toggleTheme = () => {
      const cur = root.hasAttribute("data-theme-dark") ? "dark" : "light";
      const next = cycle(cur, THEMES);
      localStorage.setItem(STORAGE.theme, next);
      applyTheme(next);
    };

    const toggleMode = () => {
      const cur = root.getAttribute("data-mode") ?? "normal";
      const next = cycle(cur, MODES);
      localStorage.setItem(STORAGE.mode, next);
      applyMode(next);
    };

    applyTheme(
      readStored(STORAGE.theme, THEMES) ?? (prefersDark() ? "dark" : "light")
    );
    applyMode(readStored(STORAGE.mode, MODES) ?? "normal");

    window
      .matchMedia?.("(prefers-color-scheme: dark)")
      .addEventListener("change", () => {
        if (!readStored(STORAGE.theme, THEMES)) {
          applyTheme(prefersDark() ? "dark" : "light");
        }
      });

    document
      .getElementById("theme-toggle")
      ?.addEventListener("click", toggleTheme);
    document
      .getElementById("theme-toggle-menu")
      ?.addEventListener("click", toggleTheme);

    document
      .getElementById("mode-toggle")
      ?.addEventListener("click", toggleMode);
    document
      .getElementById("mode-toggle-menu")
      ?.addEventListener("click", toggleMode);

    const menuBtn = document.getElementById("menu-toggle");
    const panel = document.getElementById("menu-panel");

    const setOpen = (open) => {
      root.setAttribute("data-nav-open", open ? "true" : "false");
      menuBtn?.setAttribute("aria-expanded", open ? "true" : "false");
    };

    const isOpen = () => root.getAttribute("data-nav-open") === "true";

    setOpen(false);

    menuBtn?.addEventListener("click", () => setOpen(!isOpen()));

    panel?.addEventListener("click", (e) => {
      if (e.target?.closest?.("a")) setOpen(false);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpen(false);
    });

    window.addEventListener("resize", () => {
      if (window.innerWidth > 480) setOpen(false);
    });
  })();
</script>
