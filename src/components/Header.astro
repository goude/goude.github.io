---
import { NAV_ITEMS, type NavItem } from "@/types/site";

interface Props {
  current?: string | undefined;
}

const { current = "" } = Astro.props;

function isSelected(item: NavItem): boolean {
  return item.href === `/${current}`;
}
---

<header class="site-header">
  <!-- Logo / Home -->
  <a
    href="/"
    class="logo"
    title="Guard what you give your attention to. It quietly becomes who you are."
  >
    <i class="fa-solid fa-bullseye" aria-hidden="true"></i>
    <span class="sr-only">Home</span>
  </a>

  <!-- Hamburger (mobile only) -->
  <button
    class="menu-toggle btn"
    id="menu-toggle"
    type="button"
    aria-label="Toggle navigation menu"
    aria-controls="menu-panel"
    aria-expanded="false"
  >
    <i class="fa-solid fa-bars" aria-hidden="true"></i>
  </button>

  <!-- Desktop nav -->
  <nav class="main-nav desktop-only" aria-label="Main navigation">
    {
      NAV_ITEMS.map((item) => (
        <a
          href={item.href}
          class:list={["nav-link", { selected: isSelected(item) }]}
          {...(item.external
            ? { rel: "noopener noreferrer", target: "_blank" }
            : {})}
        >
          <i class={item.icon} aria-hidden="true" />
          <span>{item.label}</span>
        </a>
      ))
    }
  </nav>

  <!-- Desktop toggles -->
  <div class="toggles desktop-only" aria-label="Appearance controls">
    <button
      class="theme-toggle btn"
      id="theme-toggle"
      type="button"
      aria-label="Toggle theme"
    >
      <i class="fa-regular fa-sun" id="icon-light" aria-hidden="true"></i>
      <i class="fa-solid fa-moon" id="icon-dark" aria-hidden="true"></i>
      <span class="sr-only">Theme</span>
    </button>

    <button
      class="mode-toggle btn"
      id="mode-toggle"
      type="button"
      aria-label="Toggle content mode"
    >
      <i class="fa-regular fa-circle" data-mode-icon="normal" aria-hidden="true"
      ></i>
      <i
        class="fa-regular fa-note-sticky"
        data-mode-icon="notes"
        aria-hidden="true"></i>
      <i class="fa-solid fa-brain" data-mode-icon="thoughts" aria-hidden="true"
      ></i>
      <span class="sr-only">Mode</span>
    </button>
  </div>

  <!-- Mobile pancake menu (everything) -->
  <nav class="menu-panel" id="menu-panel" aria-label="Menu">
    <div class="menu-divider" aria-hidden="true"></div>

    {
      NAV_ITEMS.map((item) => (
        <a
          href={item.href}
          class:list={["menu-item", { selected: isSelected(item) }]}
          {...(item.external
            ? { rel: "noopener noreferrer", target: "_blank" }
            : {})}
        >
          <i class={item.icon} aria-hidden="true" />
          <span>{item.label}</span>
        </a>
      ))
    }

    <button class="menu-item menu-action" id="theme-toggle-menu" type="button">
      <i class="fa-regular fa-sun" data-theme-icon="light" aria-hidden="true"
      ></i>
      <i class="fa-solid fa-moon" data-theme-icon="dark" aria-hidden="true"></i>
      <span>Theme</span>
    </button>

    <button class="menu-item menu-action" id="mode-toggle-menu" type="button">
      <i class="fa-regular fa-circle" data-mode-icon="normal" aria-hidden="true"
      ></i>
      <i
        class="fa-regular fa-note-sticky"
        data-mode-icon="notes"
        aria-hidden="true"></i>
      <i class="fa-solid fa-brain" data-mode-icon="thoughts" aria-hidden="true"
      ></i>
      <span>Mode</span>
    </button>
  </nav>
</header>

<style>
  /* ---------- base ---------- */
  .site-header {
    display: flex;
    align-items: center;
    justify-content: flex-start;
    gap: 0.5rem;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Shared button styling */
  .btn {
    background: none;
    border: none;
    font-size: 1.1em;
    cursor: pointer;
    padding: 0.25rem 0.6rem;
    color: inherit;
    transition: opacity 0.15s ease;
  }

  .btn:hover {
    opacity: 0.7;
  }

  /* Logo */
  .logo {
    flex: 0 0 auto;
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    font-size: 1.1em;
    padding: 0.25rem 0.6rem;
    text-decoration: none;
    color: inherit;
    transition: opacity 0.15s ease;
  }

  .logo:hover {
    opacity: 0.7;
  }

  /* Desktop nav */
  .main-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-sans);
    font-weight: 700;
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    text-decoration: none;
    color: inherit;
    letter-spacing: 0.08em;
    white-space: nowrap;
    transition:
      background-color 0.15s ease,
      color 0.15s ease;
  }

  .nav-link i {
    font-size: 1.1em;
  }

  /* Shared selected style (desktop + mobile menu items) */
  .selected {
    background: var(--fg);
    color: var(--bg);
  }

  /* Desktop toggles */
  .toggles {
    margin-left: auto;
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  /* Hamburger positioning (mobile top row) */
  .menu-toggle {
    margin-left: auto;
  }

  /* Theme icons (desktop) */
  #icon-dark {
    display: none;
  }
  :global([data-theme-dark]) #icon-light {
    display: none;
  }
  :global([data-theme-dark]) #icon-dark {
    display: inline;
  }

  /* Mode icons (desktop) */
  .mode-toggle [data-mode-icon="normal"] {
    display: inline;
  }
  .mode-toggle [data-mode-icon="notes"],
  .mode-toggle [data-mode-icon="thoughts"] {
    display: none;
  }
  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="normal"] {
    display: inline;
  }
  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="notes"],
  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: none;
  }
  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="notes"] {
    display: inline;
  }
  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="normal"],
  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: none;
  }
  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: inline;
  }
  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="normal"],
  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="notes"] {
    display: none;
  }

  /* Mobile menu defaults */
  .menu-toggle,
  .menu-panel {
    display: none;
  }

  @media (max-width: 480px) {
    .site-header {
      flex-wrap: wrap;
    }

    .desktop-only {
      display: none !important;
    }

    .menu-toggle {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .menu-panel {
      width: 100%;
      flex-basis: 100%;
      order: 999;
      display: none;
      flex-direction: column;
      align-items: stretch;
      gap: 0.25rem;
      padding: 0.25rem 0;
      font-family: var(--font-sans);
      font-weight: 700;
    }

    :global([data-nav-open="true"]) .menu-panel {
      display: flex;
    }

    .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.45rem 0.6rem;
      border-radius: 12px;
      text-decoration: none;
      letter-spacing: 0.04em;
      font-size: 0.98em;
      font-family: var(--font-sans);
      font-weight: 700;
    }
    /*
      color: inherit;
      transition:
        background-color 0.15s ease,
        color 0.15s ease,
        opacity 0.15s ease;
    }
    */

    .menu-item i {
      font-size: 1em;
    }

    .menu-action {
      background: none;
      border: none;
      cursor: pointer;
      text-align: left;
    }

    .menu-divider {
      height: 1px;
      opacity: 0.15;
      background: currentColor;
      margin: 0.15rem 0.6rem;
    }

    /* Theme icons (mobile menu) */
    .menu-panel [data-theme-icon="dark"] {
      display: none;
    }
    :global([data-theme-dark]) .menu-panel [data-theme-icon="light"] {
      display: none;
    }
    :global([data-theme-dark]) .menu-panel [data-theme-icon="dark"] {
      display: inline;
    }

    /* Mode icons (mobile menu) */
    .menu-panel [data-mode-icon="normal"] {
      display: inline;
    }
    .menu-panel [data-mode-icon="notes"],
    .menu-panel [data-mode-icon="thoughts"] {
      display: none;
    }
    :global([data-mode="normal"]) .menu-panel [data-mode-icon="normal"] {
      display: inline;
    }
    :global([data-mode="normal"]) .menu-panel [data-mode-icon="notes"],
    :global([data-mode="normal"]) .menu-panel [data-mode-icon="thoughts"] {
      display: none;
    }
    :global([data-mode="notes"]) .menu-panel [data-mode-icon="notes"] {
      display: inline;
    }
    :global([data-mode="notes"]) .menu-panel [data-mode-icon="normal"],
    :global([data-mode="notes"]) .menu-panel [data-mode-icon="thoughts"] {
      display: none;
    }
    :global([data-mode="thoughts"]) .menu-panel [data-mode-icon="thoughts"] {
      display: inline;
    }
    :global([data-mode="thoughts"]) .menu-panel [data-mode-icon="normal"],
    :global([data-mode="thoughts"]) .menu-panel [data-mode-icon="notes"] {
      display: none;
    }
  }
</style>

<script is:inline>
  (function () {
    "use strict";

    const STORAGE = { theme: "theme", mode: "mode" };
    const THEMES = ["light", "dark"];
    const MODES = ["normal", "notes", "thoughts"];
    const root = document.documentElement;

    const prefersDark = () =>
      window.matchMedia?.("(prefers-color-scheme: dark)").matches;

    const readStored = (key, allowed) => {
      const v = localStorage.getItem(key);
      return allowed.includes(v) ? v : null;
    };

    const cycle = (cur, list) => list[(list.indexOf(cur) + 1) % list.length];

    const applyTheme = (t) => {
      root.toggleAttribute("data-theme-dark", t === "dark");
      root.toggleAttribute("data-theme-light", t === "light");
    };

    const applyMode = (m) => {
      root.setAttribute("data-mode", m);
    };

    const toggleTheme = () => {
      const cur = root.hasAttribute("data-theme-dark") ? "dark" : "light";
      const next = cycle(cur, THEMES);
      localStorage.setItem(STORAGE.theme, next);
      applyTheme(next);
    };

    const toggleMode = () => {
      const cur = root.getAttribute("data-mode") ?? "normal";
      const next = cycle(cur, MODES);
      localStorage.setItem(STORAGE.mode, next);
      applyMode(next);
    };

    applyTheme(
      readStored(STORAGE.theme, THEMES) ?? (prefersDark() ? "dark" : "light")
    );
    applyMode(readStored(STORAGE.mode, MODES) ?? "normal");

    window
      .matchMedia?.("(prefers-color-scheme: dark)")
      .addEventListener("change", () => {
        if (!readStored(STORAGE.theme, THEMES)) {
          applyTheme(prefersDark() ? "dark" : "light");
        }
      });

    document
      .getElementById("theme-toggle")
      ?.addEventListener("click", toggleTheme);
    document
      .getElementById("theme-toggle-menu")
      ?.addEventListener("click", toggleTheme);

    document
      .getElementById("mode-toggle")
      ?.addEventListener("click", toggleMode);
    document
      .getElementById("mode-toggle-menu")
      ?.addEventListener("click", toggleMode);

    const menuBtn = document.getElementById("menu-toggle");
    const panel = document.getElementById("menu-panel");

    const setOpen = (open) => {
      root.setAttribute("data-nav-open", open ? "true" : "false");
      menuBtn?.setAttribute("aria-expanded", open ? "true" : "false");
    };

    const isOpen = () => root.getAttribute("data-nav-open") === "true";

    setOpen(false);

    menuBtn?.addEventListener("click", () => setOpen(!isOpen()));

    panel?.addEventListener("click", (e) => {
      if (e.target?.closest?.("a")) setOpen(false);
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") setOpen(false);
    });

    window.addEventListener("resize", () => {
      if (window.innerWidth > 480) setOpen(false);
    });
  })();
</script>
