---
import { NAV_ITEMS, type NavItem } from "@/types/site";

interface Props {
  current?: string | undefined;
}

const { current = "" } = Astro.props;

function isSelected(item: NavItem): boolean {
  return item.href === `/${current}`;
}
---

<header>
  <a
    href="/"
    class="logo"
    title="Guard what you give your attention to. It quietly becomes who you are."
  >
    <i class="fa-solid fa-bullseye" aria-hidden="true"></i>
    <span class="sr-only">Home</span>
  </a>

  <nav class="main-nav" aria-label="Main navigation">
    {
      NAV_ITEMS.map((item) => (
        <a
          href={item.href}
          class:list={["nav-link", { selected: isSelected(item) }]}
          {...(item.external
            ? { rel: "noopener noreferrer", target: "_blank" }
            : {})}
        >
          <i class={item.icon} aria-hidden="true" />
          <span>{item.label}</span>
        </a>
      ))
    }
  </nav>

  <div class="toggles" aria-label="Appearance controls">
    <button
      class="theme-toggle"
      id="theme-toggle"
      type="button"
      aria-label="Toggle theme"
    >
      <i class="fa-regular fa-sun" id="icon-light" aria-hidden="true"></i>
      <i class="fa-solid fa-moon" id="icon-dark" aria-hidden="true"></i>
    </button>
    <button
      class="mode-toggle"
      id="mode-toggle"
      type="button"
      aria-label="Toggle content mode"
    >
      <i class="fa-regular fa-circle" data-mode-icon="normal" aria-hidden="true"
      ></i>
      <i
        class="fa-regular fa-note-sticky"
        data-mode-icon="notes"
        aria-hidden="true"></i>
      <i
        class="fa-solid fa-brain"
        data-mode-icon="thoughts"
        aria-hidden="true"
      ></i>
    </button>
  </div>
</header>

<style>
  /* Logo */
  .logo {
    font-size: 1.1em;
    padding: 0.25rem 0.6rem;
    color: inherit;
    text-decoration: none;
    transition: opacity 0.15s ease;
  }

  .logo:hover {
    opacity: 0.7;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  /* Nav */
  .main-nav {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-family: var(--font-sans);
    font-weight: 700;
  }

  .nav-link {
    display: inline-flex;
    align-items: center;
    gap: 0.35rem;
    padding: 0.25rem 0.6rem;
    border-radius: 999px;
    text-decoration: none;
    color: inherit;
    letter-spacing: 0.08em;
    white-space: nowrap;
    transition:
      background-color 0.15s ease,
      color 0.15s ease;
  }

  .nav-link i {
    font-size: 1.1em;
  }

  .selected {
    background: var(--fg);
    color: var(--bg);
  }

  @media (max-width: 480px) {
    .main-nav {
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.35rem 0.6rem;
    }

    .nav-link {
      padding: 0.2rem 0.45rem;
      letter-spacing: 0.04em;
      font-size: 0.95em;
    }

    .nav-link i {
      font-size: 1em;
    }
  }

  /* Toggles */
  .toggles {
    display: inline-flex;
    align-items: center;
    gap: 0.25rem;
  }

  .theme-toggle,
  .mode-toggle {
    background: none;
    border: none;
    font-size: 1.1em;
    cursor: pointer;
    padding: 0.25rem 0.6rem;
    color: inherit;
    transition: opacity 0.15s ease;
  }

  .theme-toggle:hover,
  .mode-toggle:hover {
    opacity: 0.7;
  }

  /* Theme icons */
  #icon-dark {
    display: none;
  }

  :global([data-theme-dark]) #icon-light {
    display: none;
  }

  :global([data-theme-dark]) #icon-dark {
    display: inline;
  }

  /* Mode icons */
  .mode-toggle [data-mode-icon="normal"] {
    display: inline;
  }

  .mode-toggle [data-mode-icon="notes"],
  .mode-toggle [data-mode-icon="thoughts"] {
    display: none;
  }

  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="normal"] {
    display: inline;
  }

  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="notes"],
  :global([data-mode="normal"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: none;
  }

  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="notes"] {
    display: inline;
  }

  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="normal"],
  :global([data-mode="notes"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: none;
  }

  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="thoughts"] {
    display: inline;
  }

  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="normal"],
  :global([data-mode="thoughts"]) .mode-toggle [data-mode-icon="notes"] {
    display: none;
  }
</style>

<script is:inline>
  (function () {
    "use strict";
    const STORAGE = {
      theme: "theme",
      mode: "mode",
    };
    const THEMES = ["light", "dark"];
    const MODES = ["normal", "notes", "thoughts"];
    const root = document.documentElement;
    const prefersDark = () =>
      window.matchMedia?.("(prefers-color-scheme: dark)").matches;
    const readStored = (key, allowed) => {
      const value = localStorage.getItem(key);
      return allowed.includes(value) ? value : null;
    };
    const cycle = (current, list) =>
      list[(list.indexOf(current) + 1) % list.length];
    const applyTheme = (theme) => {
      root.toggleAttribute("data-theme-dark", theme === "dark");
      root.toggleAttribute("data-theme-light", theme === "light");
    };
    const applyMode = (mode) => {
      root.setAttribute("data-mode", mode);
    };
    const initialTheme =
      readStored(STORAGE.theme, THEMES) ?? (prefersDark() ? "dark" : "light");
    const initialMode = readStored(STORAGE.mode, MODES) ?? "normal";
    applyTheme(initialTheme);
    applyMode(initialMode);
    document.getElementById("theme-toggle")?.addEventListener("click", () => {
      const current = root.hasAttribute("data-theme-dark") ? "dark" : "light";
      const next = cycle(current, THEMES);
      localStorage.setItem(STORAGE.theme, next);
      applyTheme(next);
    });
    window
      .matchMedia?.("(prefers-color-scheme: dark)")
      .addEventListener("change", () => {
        if (!readStored(STORAGE.theme, THEMES)) {
          applyTheme(prefersDark() ? "dark" : "light");
        }
      });
    document.getElementById("mode-toggle")?.addEventListener("click", () => {
      const current = root.getAttribute("data-mode") ?? "normal";
      const next = cycle(current, MODES);
      localStorage.setItem(STORAGE.mode, next);
      applyMode(next);
    });
  })();
</script>
