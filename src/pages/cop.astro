---
import BaseLayout from "../layouts/BaseLayout.astro";

const title = "cop — cloud clipboard portal";
const description = "View and update whatever cop -n last pushed.";
const permalink = `${Astro.site!.href}cop`;
---

<BaseLayout
  title={title}
  description={description}
  permalink={permalink}
  current="cop"
>
  <section>
    <h1>cop</h1>
    <p class="lede">
      Simple cloud clipboard backed by a tiny Worker. Intended only for
      non-sensitive, public data.
    </p>
  </section>

  <section>
    <script
      is:inline
      src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"
      defer></script>

    <style>
      .cop-container {
        margin-top: 1rem;
        max-width: 48rem;
        margin-left: auto;
        margin-right: auto;
        font-family:
          system-ui,
          -apple-system,
          BlinkMacSystemFont,
          sans-serif;
      }

      .cop-status {
        font-family: monospace;
        font-size: 0.9rem;
        margin: 0.5rem 0 1rem;
        color: #555;
      }

      .cop-qr-wrapper {
        margin-bottom: 0.75rem;
      }

      .cop-qr-wrapper canvas {
        display: block;
        margin-top: 0.5rem;
        width: 400px;
        height: 400px;
        max-width: 100%;
        max-height: 100%;
      }

      .cop-url-link {
        font-size: 0.9rem;
        word-break: break-all;
        margin-top: 0.5rem;
        display: inline-block;
      }

      .cop-input {
        width: 100%;
        box-sizing: border-box;
        border-radius: 4px;
        border: 1px solid #ddd;
        padding: 0.5rem 0.75rem;
        font-family: monospace;
        font-size: 0.9rem;
        min-height: 6rem;
        resize: vertical;
        margin-top: 1.5rem;
      }

      .cop-actions {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
        justify-content: flex-end;
      }

      .cop-button {
        border: 1px solid #ccc;
        background: #f7f7f7;
        padding: 0.25rem 0.8rem;
        font-size: 0.8rem;
        cursor: pointer;
        border-radius: 999px;
      }

      .cop-button:hover:enabled {
        background: #eee;
      }

      .cop-button:disabled {
        opacity: 0.6;
        cursor: default;
      }

      .cop-charcount {
        margin-top: 0.25rem;
        font-size: 0.75rem;
        color: #888;
        text-align: right;
      }

      .lede {
        margin: 0.5rem 0 0;
        color: #555;
        font-size: 0.95rem;
      }
    </style>

    <div class="cop-container">
      <div class="cop-status" id="cop-status">
        Fetching from cloud clipboard…
      </div>

      <div class="cop-qr-wrapper">
        <canvas id="cop-qr-canvas"></canvas>
        <a
          id="cop-url-link"
          class="cop-url-link"
          href="#"
          target="_blank"
          rel="noopener noreferrer"></a>
      </div>

      <textarea
        id="cop-input"
        class="cop-input"
        maxlength="2048"
        placeholder="(no data yet)"></textarea>
      <div class="cop-charcount" id="cop-charcount">0 / 2048</div>

      <div class="cop-actions">
        <button type="button" class="cop-button" id="cop-copy-btn">
          copy
        </button>
        <button type="button" class="cop-button" id="cop-update-btn">
          update
        </button>
      </div>
    </div>

    <script is:inline>
      (function () {
        const SERVICE_URL = "https://cop.daniel-goude.workers.dev/cop";
        const MAX_CHARS_UI = 2048;

        const statusEl = document.getElementById("cop-status");
        const inputEl = document.getElementById("cop-input");
        const charCountEl = document.getElementById("cop-charcount");
        const copyBtn = document.getElementById("cop-copy-btn");
        const updateBtn = document.getElementById("cop-update-btn");
        const qrCanvas = document.getElementById("cop-qr-canvas");
        const urlLink = document.getElementById("cop-url-link");

        function utf8ToBase64(text) {
          const encoder = new TextEncoder();
          const bytes = encoder.encode(text);
          let binary = "";
          for (let i = 0; i < bytes.length; i++) {
            binary += String.fromCharCode(bytes[i]);
          }
          return btoa(binary);
        }

        function base64ToUtf8_safe(b64) {
          try {
            const binary = atob(b64);
            const len = binary.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
              bytes[i] = binary.charCodeAt(i);
            }
            return new TextDecoder().decode(bytes);
          } catch {
            // If it's not valid base64, just treat as plain text
            return b64;
          }
        }

        function updateCharCount() {
          if (!inputEl || !charCountEl) return;
          const len = inputEl.value.length;
          charCountEl.textContent = len + " / " + MAX_CHARS_UI;
        }

        function clearQR() {
          if (!qrCanvas) return;
          const ctx = qrCanvas.getContext("2d");
          if (ctx) {
            ctx.clearRect(0, 0, qrCanvas.width, qrCanvas.height);
          }
        }

        function renderQR(value) {
          if (!qrCanvas || !window.QRCode) return;
          if (!value) {
            clearQR();
            return;
          }
          window.QRCode.toCanvas(qrCanvas, value, {
            margin: 2,
            width: 400,
          });
        }

        function setUrl(url) {
          if (!urlLink) return;
          if (!url) {
            urlLink.textContent = "";
            urlLink.removeAttribute("href");
            return;
          }
          urlLink.href = url;
          urlLink.textContent = url;
        }

        async function refreshFromServer() {
          if (!statusEl || !inputEl) return;

          statusEl.textContent = "Fetching from cloud clipboard…";
          inputEl.value = "";
          updateCharCount();
          clearQR();
          setUrl("");

          try {
            const res = await fetch(SERVICE_URL, {
              method: "GET",
              mode: "cors",
            });
            if (!res.ok) {
              throw new Error("HTTP " + res.status);
            }

            const encoded = await res.text();
            const txt = base64ToUtf8_safe(encoded.trim());
            const url = txt || "";

            inputEl.value = txt.slice(0, MAX_CHARS_UI);
            updateCharCount();

            if (url) {
              renderQR(url);
              setUrl(url);
            } else {
              clearQR();
              setUrl("");
            }

            statusEl.textContent =
              "Loaded " +
              inputEl.value.length +
              " characters from cloud clipboard.";
          } catch (e) {
            console.error(e);
            statusEl.textContent = "Failed to fetch from cloud clipboard.";
            inputEl.placeholder = "(error fetching value)";
          }
        }

        function setupCopy() {
          if (!copyBtn || !inputEl || !statusEl) return;

          copyBtn.addEventListener("click", async () => {
            const text = inputEl.value;
            try {
              if (navigator.clipboard && navigator.clipboard.writeText) {
                await navigator.clipboard.writeText(text);
              } else {
                const tmp = document.createElement("textarea");
                tmp.value = text;
                tmp.style.position = "fixed";
                tmp.style.opacity = "0";
                document.body.appendChild(tmp);
                tmp.focus();
                tmp.select();
                document.execCommand("copy");
                document.body.removeChild(tmp);
              }
              statusEl.textContent = "Copied to local clipboard.";
            } catch {
              statusEl.textContent = "Failed to copy to clipboard.";
            }
          });
        }

        function setupUpdate() {
          if (!updateBtn || !inputEl || !statusEl) return;

          inputEl.addEventListener("input", () => {
            if (inputEl.value.length > MAX_CHARS_UI) {
              inputEl.value = inputEl.value.slice(0, MAX_CHARS_UI);
            }
            updateCharCount();
          });

          updateBtn.addEventListener("click", async () => {
            const txt = inputEl.value.slice(0, MAX_CHARS_UI);
            const encoded = utf8ToBase64(txt);

            statusEl.textContent = "Updating cloud clipboard…";
            updateBtn.disabled = true;

            try {
              const res = await fetch(SERVICE_URL, {
                method: "POST",
                mode: "cors",
                body: encoded,
              });
              if (!res.ok) {
                throw new Error("HTTP " + res.status);
              }

              statusEl.textContent =
                "Updated cloud clipboard with " + txt.length + " characters.";

              await refreshFromServer();
            } catch (e) {
              console.error(e);
              statusEl.textContent = "Failed to update cloud clipboard.";
            } finally {
              updateBtn.disabled = false;
            }
          });
        }

        document.addEventListener("DOMContentLoaded", () => {
          setupCopy();
          setupUpdate();
          refreshFromServer();
        });
      })();
    </script>
  </section>
</BaseLayout>
